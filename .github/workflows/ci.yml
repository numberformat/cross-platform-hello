name: build-and-release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            c_compiler: gcc
            cxx_compiler: g++
            build_type: Release
          - os: macos-latest
            c_compiler: clang
            cxx_compiler: clang++
            build_type: Release
          - os: windows-latest
            generator: "Visual Studio 17 2022"
            arch: x64
            build_type: Release

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install wxWidgets (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwxgtk3.2-dev

      - name: Install wxWidgets (macOS)
        if: runner.os == 'macOS'
        run: brew install wxwidgets

      - name: Install wxWidgets (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          WX_VERSION: "3.2.5"
        run: |
          git clone --depth 1 --branch v$env:WX_VERSION https://github.com/wxWidgets/wxWidgets.git $env:RUNNER_TEMP\wxWidgets
          cmake -S $env:RUNNER_TEMP\wxWidgets -B $env:RUNNER_TEMP\wxWidgets\build `
            -G "${{ matrix.generator }}" -A ${{ matrix.arch }} `
            -DwxBUILD_SHARED=OFF `
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}\wxwidgets-install"
          cmake --build $env:RUNNER_TEMP\wxWidgets\build --config ${{ matrix.build_type }} --target INSTALL

      - name: Configure (POSIX)
        if: runner.os != 'Windows'
        env:
          CC: ${{ matrix.c_compiler }}
          CXX: ${{ matrix.cxx_compiler }}
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        run: cmake -S . -B build -G "${{ matrix.generator }}" -A ${{ matrix.arch }} -DwxWidgets_ROOT_DIR="${{ github.workspace }}\wxwidgets-install"

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Install
        run: cmake --install build --config ${{ matrix.build_type }} --prefix dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: hello-${{ runner.os }}
          path: dist/**

  release:
    name: Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Bundle binaries
        run: |
          mkdir release
          for dir in artifacts/*; do
            name=$(basename "$dir")
            tar -czf "release/${name}.tar.gz" -C artifacts "$name"
          done

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.tar.gz
